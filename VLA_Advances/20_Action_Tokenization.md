# 20. 动作表示：从离散 Token 到扩散生成

## 1. 为什么"动作表示"是 VLA 的核心问题？

VLM 的输出是文本 Token（离散的、有限词表的）。但机器人动作是**连续的、高维的、高精度的**：

```
文本 Token：   "hello" → [15339]           （离散，有限词表，精度无所谓）
机器人动作：   Δx = 0.0237m                （连续，无限精度，毫米级误差就会导致抓取失败）
```

**核心矛盾**：如何用一个基于离散 Token 的语言模型来输出高精度的连续动作？

这就是"动作表示 (Action Representation / Action Tokenization)"问题——VLA 区别于 VLM 的最本质差异。

## 2. 四大动作表示方法

### (a) 方法一：均匀离散化 (Uniform Binning)

**代表**：RT-2, OpenVLA

**原理**：将每个动作维度均匀切分为 N 个区间 (Bin)，把回归问题转化为分类问题。

```
动作空间 Δx ∈ [-0.1, 0.1]
切分为 256 个 Bin：
  Bin 0 = [-0.100, -0.099]
  Bin 1 = [-0.099, -0.098]
  ...
  Bin 128 = [0.000, 0.001]  ← 零点附近
  ...
  Bin 255 = [0.099, 0.100]

实际动作 Δx = 0.0237 → 映射到 Bin 153 → 解码为 ≈ 0.024
```

**7 维动作 → 7 个分类 Token**，直接用 LLM 的词表生成。

| 优点 | 缺点 |
| :--- | :--- |
| 实现极简，直接复用 LLM 框架 | 精度有限（256 Bin → 分辨率 ~0.8mm） |
| 不需要额外的动作解码头 | 各维度独立预测，忽略维度间关联 |
| 训练稳定 | 对高频控制任务（灵巧操作）精度不够 |

### (b) 方法二：FAST（频域动作序列编码）

**代表**：π0-FAST（Physical Intelligence, 2025.01）

**动机**：均匀 Binning 的两个根本问题：
1.  **精度不够**：灵巧操作（如拧螺丝）需要亚毫米精度。
2.  **效率太低**：每步 7 个 Token × 16 步 Action Chunk = 112 个 Token 要逐个生成。

**核心思想**：用**离散余弦变换 (DCT)** 将动作序列从时域压缩到频域。

```
时域动作序列 (16 步 × 7 维 = 112 个值)：
  [0.02, 0.03, 0.04, 0.05, ...]  ← 原始动作序列，变化平滑
       ↓ DCT 变换
频域系数 (保留前 K 个低频分量)：
  [0.15, -0.03, 0.01, ...]        ← 大幅压缩！只需 ~20 个系数
       ↓ 量化为 Token
  [Token_1, Token_2, ..., Token_20]
```

**为什么有效？** 机器人动作在时间上通常是**平滑的**（不会突然从左跳到右），所以大部分能量集中在低频分量上。DCT 可以用少量系数高精度重建整段动作。

| 优点 | 缺点 |
| :--- | :--- |
| **压缩率高**：112 个值 → ~20 个 Token | 需要训练专用的 Tokenizer |
| **精度高**：保留了动作的连续特性 | 对突变动作（碰撞）重建有损 |
| **速度快**：Token 数大幅减少 → 自回归更快 | DCT 假设动作平滑，极端情况失效 |
| **通用性强**：FAST+ 在 100 万轨迹上预训练 | — |

**关键成果**：π0-FAST 在保持与扩散版 π0 相同性能的同时，训练时间减少 **5 倍**。

### (c) 方法三：扩散策略 (Diffusion Policy)

**代表**：π0, Octo, Diffusion Policy (Chi et al. 2023)

**核心思想**：不用离散 Token，而是用**扩散模型 (Diffusion Model)** 直接生成连续动作。

```
噪声动作 a_T ~ N(0, I)    （纯噪声）
      ↓  去噪步骤 1 (条件：图像 + 语言 + 本体)
半噪声动作 a_{T-1}
      ↓  去噪步骤 2
      ...
      ↓  去噪步骤 T
干净动作 a_0 = [0.0237, -0.0103, 0.0491, ...]   （高精度连续值）
```

**关键优势：建模多模态分布**

同一个任务可能有多种正确做法（从左边绕或从右边绕），自回归只能输出一种，扩散可以建模完整的分布：

```
         ┌─ 方案 A: 从左边绕过障碍物
任务 ──→ │
         └─ 方案 B: 从右边绕过障碍物

自回归输出：取平均 → 直直撞上障碍物（灾难！）
扩散输出：  随机采样一种方案 → 完整地从一侧绕过 ✅
```

| 优点 | 缺点 |
| :--- | :--- |
| **精度最高**：输出连续值，无量化误差 | 去噪需要多步迭代 (~10步) |
| **多模态分布**：避免 mode averaging 灾难 | 推理速度慢 |
| **Action Chunking 自然**：一次生成整段轨迹 | 训练比自回归复杂 |
| 适合灵巧操作（精细拧装、布料折叠） | 与 LLM 自回归框架不统一 |

### (d) 方法四：离散扩散 (Discrete Diffusion VLA)

**代表**：Discrete Diffusion VLA（2025）

**动机**：扩散策略精度高但与 LLM 框架不统一；自回归统一但精度低。能否两全？

**核心思想**：在 LLM 的 Transformer 骨干内部，用**离散扩散**代替自回归来生成动作 Token。

```
输入:  [Image] [Text] [Mask Mask Mask Mask Mask Mask Mask]  ← 7 个被遮蔽的动作位置
                          ↓ 离散扩散去噪
步骤1: [Image] [Text] [?    ?    128  ?    ?    ?    ?]      ← 先解码最"容易"的维度
步骤2: [Image] [Text] [?    91   128  241  ?    ?    ?]
步骤3: [Image] [Text] [1    91   128  241  5    101  128]    ← 全部解码完成
```

**关键创新**：
*   **自适应解码顺序**：先解码确信度高的维度，再解码难的（不像自回归固定从左到右）。
*   **纠错机制 (Re-masking)**：解码后可以重新遮蔽不确信的 Token 再解码一次。

| 优点 | 缺点 |
| :--- | :--- |
| 与 LLM Transformer **统一架构** | 仍然是离散 Token，精度受限于 Bin 数 |
| 维度间建模**联合分布** | 较新，还在验证阶段 |
| 并行解码（不需要逐个生成） | — |

## 3. 四种方法总对比

| 方法 | 精度 | 速度 | 多模态分布 | 与 LLM 统一 | 代表 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **均匀 Binning** | 中 | ⭐⭐⭐ | ❌ | ✅ 完全统一 | RT-2, OpenVLA |
| **FAST (频域)** | 高 | ⭐⭐⭐⭐ | ❌ | ✅ Token 生成 | π0-FAST |
| **扩散策略** | ⭐⭐⭐⭐⭐ | ⭐ | ✅ | ❌ 需额外头 | π0, Octo |
| **离散扩散** | 中高 | ⭐⭐⭐ | ✅ | ✅ 统一 | DD-VLA |

## 4. Action Chunking (动作分块)

不管哪种动作表示，都有一个共同趋势：**一次预测未来多步动作**。

```
单步预测：  观测 → 模型 → 1 步动作 → 执行 → 观测 → 模型 → 1 步动作 → ...
                                                ↑ 每步都要调用模型，延迟高

Action Chunking：观测 → 模型 → [未来 16 步动作] → 依次执行 → 16 步后再调用模型
                                                        ↑ 模型调用频率降低 16x
```

| 好处 | 说明 |
| :--- | :--- |
| **降低推理频率** | 模型不需要每步都推理，只需每 N 步推理一次 |
| **动作平滑** | 模型一次规划整段轨迹，不会出现逐步抖动 |
| **时间一致性** | 整段动作序列是一起生成的，保持时间上的连贯性 |

典型 Chunk 大小：
*   OpenVLA: 1（逐步）
*   Octo: 4
*   π0: 16-50
*   Diffusion Policy: 8-16

## 5. 发展趋势

```
2023:  均匀 Binning (RT-2)          ← 最简单，proof of concept
2024:  扩散策略 (π0, Octo)           ← 精度飞跃，但速度慢
2025:  FAST 频域编码 (π0-FAST)       ← 速度与精度的最佳平衡
2025:  离散扩散 (DD-VLA)             ← 统一框架的新尝试
```

> **一句话总结**：动作表示是 VLA 的"语言"——选对编码方式，决定了机器人是"粗糙地比划"还是"精准地操作"。从 Binning 到 FAST 到 Diffusion，趋势是**精度越来越高、速度也在追赶、与 LLM 框架越来越统一**。
